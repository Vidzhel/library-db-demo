# DbDemo.Infrastructure.SqlKata

This project demonstrates database scaffolding and SqlKata query builder integration.

## Key Components

### Generated Schema (Generated/)
- `Tables.cs` - Compile-time constants for table names
- `Columns.cs` - Compile-time constants for column names organized by table

These files are auto-generated by running the DbDemo.Scaffolding tool.

### Query Factory Provider
`QueryFactoryProvider.cs` - Creates SqlKata QueryFactory instances from SqlTransaction

### Repositories
Complete implementations:
- `BookRepository.cs` - Full implementation showing all SqlKata patterns
- `MemberRepository.cs` - Simplified implementation showing basic CRUD

**Pattern for Other Repositories:**
The remaining repositories (Author, Loan, Category, etc.) follow the same pattern as BookRepository and MemberRepository:

1. Use `QueryFactoryProvider.Create(transaction)` to get QueryFactory
2. Use generated `Tables.*` and `Columns.*` constants for compile-time safety
3. Build queries with SqlKata fluent API
4. For complex SQL (JSON queries, CTEs, etc.), fall back to raw SQL with parameters
5. Map dynamic results to domain entities using `.FromDatabase()` factory methods

## Benefits Demonstrated

✅ **Compile-Time Safety**: Renaming a column in migration SQL → Scaffolding regenerates constants → Build errors show where to update code

✅ **Query Builder Ergonomics**: Fluent API vs string concatenation

✅ **No Magic**: Still explicit queries, just with better tooling

✅ **Migration-First**: SQL migrations remain source of truth

## Usage

1. Run migrations (changes database schema)
2. Run scaffolding tool (regenerates schema constants)
3. Update repository code (compiler guides you)
4. Build succeeds only when all references are fixed
